package org.opentestsystem.delivery.logging;

import com.google.common.base.Optional;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.util.HashMap;
import java.util.Map;

import static org.opentestsystem.delivery.logging.EventLogger.BaseEventData.HTTP_REQUEST_PARAMETERS;
import static org.opentestsystem.delivery.logging.EventLogger.BaseEventData.HTTP_SESSION_ID;


public class EventParser {

  /**
   * The default pre request parser.
   *
   * @param request
   * @return
   */
  public Optional<EventInfo> parsePreHandle(HttpServletRequest request, Object handler, EventLogger logger) {
    return Optional.of(EventInfo.create(request.getPathInfo(), getEventDataFields(request)));
  }

  /**
   * The default post request parser.
   *
   * @param request
   * @return
   */
  public Optional<EventInfo> parsePostHandle(HttpServletRequest request, HttpServletResponse response, Object
    handler, EventLogger logger) {
    return Optional.of(EventInfo.create(request.getPathInfo(), EventLogger.Checkpoint.EXIT.name(), getEventDataFields
      (request)));
  }

  protected Map<EventLogger.EventData, Object> getEventDataFields(HttpServletRequest request) {
    HashMap<EventLogger.EventData, Object> data = new HashMap<>();

    HttpSession session = request.getSession(false);
    if (null != session) {
      data.put(HTTP_SESSION_ID, session.getId());
    }
    data.put(HTTP_REQUEST_PARAMETERS, request.getParameterMap());

    return data;
  }
}

