/***************************************************************************************************
 * Educational Online Test Delivery System
 * Copyright (c) 2017 Regents of the University of California
 *
 * Distributed under the AIR Open Source License, Version 1.0
 * See accompanying file AIR-License-1_0.txt or at
 * http://www.smarterapp.org/documents/American_Institutes_for_Research_Open_Source_Software_License.pdf
 *
 * SmarterApp Open Source Assessment Software Project: http://smarterapp.org
 * Developed by Fairway Technologies, Inc. (http://fairwaytech.com)
 * for the Smarter Balanced Assessment Consortium (http://smarterbalanced.org)
 **************************************************************************************************/

package org.opentestsystem.delivery.logging;

import com.google.common.base.Optional;
import org.apache.commons.lang.StringUtils;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;
import java.util.HashMap;
import java.util.Map;

import static org.opentestsystem.delivery.logging.EventLogger.BaseEventData.HTTP_REQUEST_PARAMETERS;
import static org.opentestsystem.delivery.logging.EventLogger.BaseEventData.HTTP_SESSION_ID;

/**
 * Map interceptor request to EventInfo value object used to log event.
 * Common fields such a http session and request parameters are stored in the returned EventInfo
 */
public class EventParser {

  /**
   * The default pre request parser.
   *
   * @param request
   * @return
   */
  public Optional<EventInfo> parsePreHandle(final HttpServletRequest request, final Object handler, final EventLogger logger) {
    return Optional.of(EventInfo.builder().event(request.getRequestURI()).data(getEventDataFields(request)).build());
  }

  /**
   * The default post request parser.
   *
   * @param request
   * @return
   */
  public Optional<EventInfo> parsePostHandle(final HttpServletRequest request, final HttpServletResponse response, final Object
    handler, final EventLogger logger) {
    return Optional.of(EventInfo.builder().event(request.getRequestURI()).data(getEventDataFields(request)).build());
  }

  public static Map<EventLogger.EventData, Object> getEventDataFields(final HttpServletRequest request) {
    final HashMap<EventLogger.EventData, Object> data = new HashMap<>();

    final HttpSession session = request.getSession(false);
    if (null != session) {
      data.put(HTTP_SESSION_ID, session.getId());
    }
    data.put(HTTP_REQUEST_PARAMETERS, request.getParameterMap());

    return data;
  }
}

